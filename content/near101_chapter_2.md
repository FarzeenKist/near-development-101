In this learning module, we will learn how to connect to a smart contract deployed on the NEAR blockchain.

## Initialize the project

The easiest way to initialize a ReactJS application is to use `create-react-app`. More details can be found [here](https://github.com/facebook/create-react-app#quick-overview).


Now we should create a `smartcontract` directory in the root of the project and move the smart contract's code there.

Next, we need to create a `utils` directory in the `src` directory where we are going to put NEAR-related code (NEAR config and marketplace definition).

The final project structure should be similar to this:
```
.
├── package.json
├── public
│   ├── favicon.ico
│   ├── index.html
│   ├── logo192.png
│   ├── logo512.png
│   ├── manifest.json
│   └── robots.txt
├── README.md
├── smartcontract
│   ├── asconfig.json
│   ├── assembly
│   │   ├── as_types.d.ts
│   │   ├── index.ts
│   │   ├── model.ts
│   │   └── tsconfig.json
│   ├── package.json
│   └── README.md
└── src
    ├── App.css
    ├── App.js
    ├── App.test.js
    ├── index.css
    ├── index.js
    ├── logo.svg
    ├── reportWebVitals.js
    ├── setupTests.js
    └── utils
        ├── config.js
        ├── marketplace.js
        └── near.js
```
where most of the files is boilerplate generated by `create-react-app`. However, we are interested in two directories that we created manually:
* `smartcontract` is the directory where the smart contract is located
* `src/utils`

Also, there two libraries that should be installed:
* `near-api-js`
* `uuid`

## IMPORTANT!
As for now, `react-scripts` of version 5 might not work with the latest node version.

Insted, we should use `react-scripts` of version 4.0.3 and NodeJS 16 or higher.

Now that we created a project structure let's jump to the config implementation.

## NEAR config and smart contract interaction

### Config
First of all, we need to define a configuration for NEAR in the `src/utils/config.js`.

```javascript=
const CONTRACT_NAME = process.env.CONTRACT_NAME || '${CONTRACT_NAME}' // 1

function environment(env) {
  switch (env) {

  case 'mainnet': // 2
    return {
      networkId: 'mainnet',
      nodeUrl: 'https://rpc.mainnet.near.org',
      contractName: CONTRACT_NAME,
      walletUrl: 'https://wallet.near.org',
      helperUrl: 'https://helper.mainnet.near.org',
      explorerUrl: 'https://explorer.mainnet.near.org',
    }
  case 'testnet': // 3
    return {
      networkId: 'testnet',
      nodeUrl: 'https://rpc.testnet.near.org',
      contractName: CONTRACT_NAME,
      walletUrl: 'https://wallet.testnet.near.org',
      helperUrl: 'https://helper.testnet.near.org',
      explorerUrl: 'https://explorer.testnet.near.org',
    }
  default:
    throw Error(`Unknown environment '${env}'.`)
  }
}

module.exports = environment
```

At line `1` a contract's name must be defined. For the sake of this course we are going to use `testnet` so you can use the same account created in the previous chapter:
* main account - myaccount.testnet
* contract - mycontract.myaccount.testnet.

Lines `2` and `3` define a configuration for both `mainnet` and `testnet` respectively.

For the sake of this course, we are going to use `testnet` only.

### Initialize a smart contract

Now we should initialize a contract together with defining functions and that's where NEAR is different compared to Ethereum or Cello. There is no such thing as `abi`. Everything that is needed to interact with the contract is to connect to id via `near-api-js` and the connection object takes an object with two properties:
* `viewMethods` - an array of methods that do not modify the state
* `changeMethods` - an array of methods that modify the state

Now let's create a `src/utils/near.js` where the entire connection is implemented: 
```javascript=
import environment from './config';
import { connect, Contract, keyStores, WalletConnection } from 'near-api-js';
import { formatNearAmount } from 'near-api-js/lib/utils/format';

const nearEnv = environment('testnet');

export async function initializeContract() {
    const near = await connect(Object.assign({ deps: { keyStore: new keyStores.BrowserLocalStorageKeyStore() } }, nearEnv)); // 1
    window.walletConnection = new WalletConnection(near); // 2
    window.accountId = window.walletConnection.getAccountId(); // 3
    window.contract = new Contract(window.walletConnection.account(), nearEnv.contractName, { // 4
      // List here all view methods
      viewMethods: ['getProduct', 'getProducts'], // 5
      // List call methods that change state
      changeMethods: ['buyProduct', 'setProduct'], // 6
    })
  }
  
  export async function accountBalance() { // 7
    return formatNearAmount((await window.walletConnection.account().getAccountBalance()).total, 2);
  }
  
  export async function getAccountId() { // 8
    return window.walletConnection.getAccountId();
  }
  
  export function login() { // 9
    window.walletConnection.requestSignIn(nearEnv.contractName);
  }
  
  export function logout() { // 10
    window.walletConnection.signOut();
    window.location.reload();
  }
```

At line `1` we create `near` object that holds a NEAR environment (either `testnet` or `mainnet`) object. Also, it holds a `keyStore` object where the wallet information is stored and the `keyStore` object is stored in the local storage of the browser.

At line `2` we create a wallet connection object that we will use to interact with the wallet (login, logout, get account's balance).

At line `3` we just read and keep `accountId` so we can use it when we want to display a logged-in account or use it to interact with a smart contract.

At line `4` we create a `contract` object that is an entry point for `viewMethods` and `changeMethods` where all exported methods from the smart contract are listed.

There is a couple of methods implemented here at lines `7`, `8`, `9` and `10` that work as proxies for smart contract methods.

And last but not least - a `src/utils/marketplace.js` config. That is the place where `getProduct`, `getProducts`, `buyProduct`, `setProduct` methods are implemented.

```javascript=
import { v4 as uuid4 } from 'uuid';
import { parseNearAmount } from 'near-api-js/lib/utils/format';

const GAS = 100000000000000; // 1

export function createProduct(product) {
  product.id = uuid4(); // 2
  product.price = parseNearAmount(product.price + ""); // 3
  return window.contract.setProduct({ product });
}

export function getProducts() {
  return window.contract.getProducts();
};

export async function buyProduct({ id, price }) {
  await window.contract.buyProduct({ productId: id }, GAS, price);
};

```

At line `1` we define a constant value for GAS attached to transactions. We set it to 100000000000000 which in fact is 100 TGas(terra gas). It does not mean that all gas will be used if you attached more than needed - all extra gas will be refunded.
However, it is possible to calculate an approximate amount of gas per operation and how much would it [cost](https://docs.near.org/docs/concepts/gas#the-cost-of-common-actions) in NEAR.

At the line `2` we create an [UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier) identifier for a product to use it as an id to store in the `PersistentUnorderedMap`. We use it for random unique identifiers for products to make sure that every product would have a unique identifier so products won't overlap when we add more.

At line `3` we parse a product's price to yocto because we store prices in that way in the contract for more convenience.

The rest of the methods are just proxies to the smart contract's method.

Now that we have implemented an integration part with NEAR, let's check that it works as expected.

Go to `src/Apps.js` and find `App()` function that was generated by `create-react-app` and replace it by this:

```javascript=
function App() {
  const account = window.walletConnection.account(); // 1
  const [products, setProducts] = useState([]);
  const fetchProducts = useCallback(async () => {
    if (account.accountId) {
      setProducts(await getProducts()); // 2
    }
  });
  useEffect(() => {
    fetchProducts();
  }, []);
  return (
    <>{
      account.accountId // 3
      ? products.forEach(product => console.log(product)) // 4
      : <button onClick={login}>CONNECT WALLET</button> // 5
    }</>
  );
}

export default App;
```

Also, add imports:
```javascript=
import React, { useCallback, useEffect, useState } from 'react';
import './App.css';
import { getProducts } from './utils/marketplace';
import { login } from './utils/near';
```

Another important change should be done to `index.js`:
```javascript=
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';
import reportWebVitals from './reportWebVitals';
import { initializeContract } from './utils/near';

window.nearInitPromise = initializeContract().then(() => {
  ReactDOM.render(
    <React.StrictMode>
        <App />
    </React.StrictMode>,
    document.getElementById('root'),
  )
}).catch(console.error)

reportWebVitals();
```
Let's ignore ReactJS-related things like `useEffect` and `useState` - we will get back to them later.

At line `1` we connect to the wallet.

At line `2` we call `getProducts()` to get products from the smart contract.

At line `3` we check if we have a logged in account. If we do, we just print products to the console at line `4`.

Otherwise, if no account available, you will see `CONNECT WALLET` button and once you clicked on it, you will be prompted to login to the wallet in your browser.

![](https://github.com/dacadeorg/near-development-101/raw/master/content/gifs/login_and_print_products_to_console.gif)